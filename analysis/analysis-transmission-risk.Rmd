---
title: "Transmission Risk"
author: "NB"
date: "2022-10-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
library(tidyverse)
library(tidybayes)
library(LaplacesDemon)

source("../utils/plotting.R")
source("../utils/tex.R")
source("../helper/settings.r")
```

## Data

```{r}
study_classes <- c("Study (A)", "Study (B)", "Study")
study_classes_names <- c("S1 (A)", "S1  (B)", "S2")
names(study_classes_names) <- study_classes

# environmental data
palas <- read_csv("../data-clean/left-palas-redcap.csv") %>%
  mutate(weekday = factor(weekday, levels = paste0(c("Mon", "Tues", "Wednes", "Thurs", "Fri"), "day")),
         intervention = factor(intervention, levels = c("Mask mandate", "No intervention", "Air cleaner")))

# case data range  
redcap_full <- readRDS("../data-clean/redcap-full-range.rds")

redcap_sim <- meta_dat <- data.frame(folders = list.files("../fitted-models/multiverse", full.names = T),
                                     dataset = as.numeric(list.files("../fitted-models/multiverse"))) %>%
  mutate(sample_file = sapply(folders, list.files, pattern = "sample.rds", full.names = T)) %>%
  mutate(observed_data = lapply(sample_file, readRDS)) %>%
  unnest() %>%
  filter(grepl("Study", class)) 
```

## Input

### Rebr. air fraction (f)

Use median rebreathed air fraction from this study

```{r}
rebAirFrac <- palas %>%
  group_by(school, class, date, intervention) %>%
  summarize(f = mean(f, na.rm = T)) %>% 
  ungroup() 
```

```{r}
rebAirFrac_pl <- rebAirFrac %>%
  mutate(class = recode(class, !!! study_classes_names),
         class = factor(class, levels = study_classes_names)) %>%
  ggplot(aes(x = class, color = intervention, y = f)) +
  geom_boxplot() +
  scale_color_manual(values = intervention_col) +
  labs(y = "Average rebreathed air fraction", title = "a") +
  theme_bw2() +
  theme(legend.position = "none", axis.title.x = element_blank())

rebAirFrac_pl
```


### No. of infectious (I)

Number of infectious cases from this study
* --> use data from probabilistic simulation and shift cases to the left (with something half-normal shaped)
* for this, use infectiousness profile from He et al: https://www.nature.com/articles/s41591-020-0869-5#Sec1
* take into account that some students stayed in school with symptoms (date absence - date symptoms)

```{r}
# Infectious profile
# shape, scale, start
inf_par <- c(20.51, 1.59, 12.27)

# plot
plot(NA, axes=F, ann=F, ylim=c(0,0.3), xlim=c(-10,8))
axis(2, las=1, at=0:3*0.1, lab=paste0(0:3*10,'%'))
abline(v=0, col=gray(0.8))
curve(dgamma(x+inf_par[3], inf_par[1], inf_par[2]), from=-10, to=8, add=T)
axis(1, at=(-5:4)*2, lab=(-5:4)*2, cex.axis=1)
mtext('Density', 2, line=3)
mtext('Days after symptom onset', 1, line=2.5)

# corresponding probability distribution
inf_dens_pl <- data.frame(x = -7:3) %>%
  mutate(y = dgamma(x+inf_par[3], inf_par[1], inf_par[2])) %>%
  ggplot(aes(x = x, y = y)) +
  geom_line() +
  geom_vline(aes(xintercept = 0), linetype = "dotted", alpha = .5) +
  labs(x = "Days since symptom onset", y = "Density") +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  theme_bw2()

inf_dens_pl

# compute infectiousness, i.e. relative probability of transmission
p_if <- function(x) {
  max_dens <- max(dgamma(seq(-5, 5, 1)+inf_par[3], inf_par[1], inf_par[2]))
  dgamma(x+inf_par[3], inf_par[1], inf_par[2]) / max_dens
}


inf_prob_pl <- data.frame(x = -7:3) %>%
  mutate(y = p_if(x)) %>%
  ggplot(aes(x = x, y = y)) +
  geom_line() +
  geom_vline(aes(xintercept = 0), linetype = "dotted", alpha = .5) +
  labs(x = "Days since symptom onset", y = "Relative prob. of transmission (%)", title = "a") +
  scale_x_continuous(expand = c(0,0), breaks = seq(-10, 4, 2)) +
  scale_y_continuous(expand = c(0,0), labels = function(x) x * 100) +
  theme_bw2()

inf_prob_pl
```

```{r}
study_period <- seq(min(redcap_full$date), max(redcap_full$date), by = "1 day")

infectious <- data.frame()

for (sc in study_classes) {
  
  redcap_sim_sc <- redcap_sim %>% 
    filter(class == sc) 
    
    message(sprintf("Class: %s", sc))
  
  for (ds in 1:max(redcap_sim_sc$dataset)) {
    
    redcap_sim_sc_ds <- redcap_sim_sc %>%
      filter(dataset == ds) %>% 
      arrange(date_start)
    
    for (t in seq_along(study_period)) {
      
      redcap_sim_sc_ds <- redcap_sim_sc_ds %>%
        filter(date_start > study_period[t]) %>%
        mutate(days_since_symptoms = as.numeric(study_period[t]-date_symptoms),
               prob_infectious = p_if(days_since_symptoms))
      
      new_entry <- data.frame(
        school = redcap_sim_sc$school[1], 
        class = sc,
        dataset = ds,
        date = study_period[t],
        I = sum(redcap_sim_sc_ds$prob_infectious))
      
      infectious <- rbind(infectious, new_entry)
    }
  }
}
```

```{r}
infectious %>%
  group_by(school, class, date) %>%
  summarise(I = mean(I)) %>%
  ungroup() %>%
  mutate(school_class = paste(school, class)) %>%
  ggplot(aes(x = date, y =  I)) +
  geom_step() +
  facet_wrap(~ school_class)
```

```{r}
infectious_sub <- infectious %>%
  left_join(redcap_full) %>%
  # remove the last study week, the week before vacation, and the vacation weeks
  mutate(study_week = week - 3) %>%
  filter(study_week > 0,
         ifelse(school == "School 1" & study_week %in% c(2,3,4,9), F, T),
         ifelse(school == "School 2" & study_week %in% c(2,3,8,9), F, T)) %>%
  filter(!(weekday %in% c("Saturday", "Sunday"))) %>%
  group_by(school, class, date, intervention) %>%
  summarise(I = mean(I)) %>%
  ungroup() 
```

```{r}
infectious_sub_pl <- infectious_sub %>%
  mutate(class = recode(class, !!! study_classes_names),
         class = factor(class, levels = study_classes_names)) %>%
  ggplot(aes(x = class, color = intervention, y = I)) +
  geom_boxplot() +
  scale_color_manual(values = intervention_col) +
  labs(y = "Estimated average number\nof infectious students", title = "b") +
  theme_bw2() +
  theme(legend.position = "none", axis.title.x = element_blank(), legend.title = element_blank())

infectious_sub_pl
```

### No. of contacts (n)

Use the number of students in the class from this study

```{r}
ncontacts <- palas %>%
  group_by(school, class, date, intervention) %>%
  slice(1) %>%
  mutate(n = n_room) %>% # actually -1, but we count one teacher per class as well
  ungroup() %>%
  select(school, class, date, intervention, n)
```

```{r}
ncontacts_pl <- ncontacts %>%
  mutate(class = recode(class, !!! study_classes_names),
         class = factor(class, levels = study_classes_names)) %>%
  ggplot(aes(x = class, color = intervention, y = n)) +
  geom_boxplot() +
  scale_color_manual(values = intervention_col) +
  labs(y = "Number of students in class", title = "c") +
  theme_bw2() +
  theme(legend.position = "right", axis.title.x = element_blank(), legend.title = element_blank())

ncontacts_pl

comb_input_pl <- arrangeGrob(rebAirFrac_pl, infectious_sub_pl, ncontacts_pl, widths = c(4.1, 4.7, 7.2), ncol = 3)
ggsave(plot = comb_input_pl, filename = "../results/supp-transrisk-input.pdf", width = 16 / cm(1), height = 5 / cm(1))
```

### Infectious quanta (q)

Infectious quanta from Buonanno 2020
* https://www.sciencedirect.com/science/article/pii/S0160412020320675?via%3Dihub
* Table 2 - Light activity, speaking (log10 ERq)
* Mean 6.98 x 10e-1; St.dev: 7.20 x 10e-1 quanta/hour

```{r}
m_q = 6.98
s_q = 7.2
logs_q = sqrt(log(s_q ^ 2 / m_q ^ 2 + 1))
logm_q = log(m_q) - logs_q ^ 2 / 2

inf_quanta_pl <- data.frame(x = seq(0, 25, .1)) %>%
  mutate(y = dlnorm(x, logm_q, logs_q)) %>%
  ggplot(aes(x = x, y = y)) +
  geom_line() +
  geom_vline(aes(xintercept = 0), linetype = "dotted", alpha = .5) +
  labs(x = "Infectious quanta (p/h)", y = "Density", title = "b") +
  scale_x_continuous(expand = c(0,0), breaks = seq(0, 25, 5)) +
  scale_y_continuous(expand = c(0,0)) +
  theme_bw2()

inf_quanta_pl

inf_pl <- arrangeGrob(inf_prob_pl, inf_quanta_pl, widths = c(8, 8), nrow = 1)
ggsave(plot = inf_pl, filename = "../results/supp-infectiousness.pdf", width = 16 / cm(1), height = 6 / cm(1))
```

```{r}
rq <- function(q) qlnorm(q, logm_q, logs_q)
quantas <- c(rq(0.025), 6.98, rq(.975))
```

### Exposure time (t)

Estimate transmission risk for 20 to 40 hours per week in school.

```{r}
durations = seq(20, 40, 5)
```


## Estimation

### Transmission risk (P)

```{r}
transRisk <- rebAirFrac %>%
  left_join(ncontacts) %>%
  left_join(infectious_sub) %>%
  dplyr::filter(!is.na(I)) %>%
  group_by(intervention) %>%
  summarize(across(c(f, I, n), mean)) %>%
  ungroup() %>%
  mutate(t = list(t = durations)) %>%
  mutate(q = list(q = quantas)) %>%
  unnest("t") %>%
  unnest("q") %>%
  mutate(P = (1 - exp(-f * I * q * t / n))) 
```

```{r}
transRisk_sum <- transRisk %>%
  mutate(q = paste0("Infectious quanta: ", round_k(q, 1), "p/h"),
         q = factor(q, levels = paste0("Infectious quanta: ", round_k(quantas, 1), "p/h")))

transRisk_sum %>%
  filter(t == 30, q == "Infectious quanta: 7.0p/h") %>%
  mutate(P = round(P * 100))

transRisk_sum %>%
  filter(t == 30, q == "Infectious quanta: 25.8p/h") %>%
  mutate(P = round(P * 100))

transRisk_pl <- transRisk_sum %>%
  ggplot(aes(x = t, y = P, color = intervention)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ q) +
  scale_color_manual(values = intervention_col) +
  scale_y_continuous(limits = c(0, NA), expand = expansion(add = c(0, .01)), labels = function(x) x * 100) + 
  facet_wrap(~ q) +
  labs(color = "Intervention", y = "Average SARS-CoV-2 risk (%)", x = "Hours of exposure") +
  theme_bw2() +
  theme(legend.position = "top", panel.spacing = unit(1, "lines"),
        plot.margin = unit(c(5.5, 7.5, 5.5, 5.5), "points"),
        legend.title = element_blank())

transRisk_pl

save_plot(transRisk_pl, pdf_file = "../results/results-transmission-risk.pdf", w = 10, h = 7)
```
