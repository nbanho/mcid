---
title: "Palas"
author: "NB"
date: "2022-08-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
library(tidyverse)
library(tidybayes)
library(reshape2)
library(lubridate)
library(rstanarm)
library(texreg)
library(gridExtra)
library(ggpubr)
library(ggridges)
library(xtable)

source("../utils/plotting.R")
source("../utils/tex.R")
source("../helper/settings.r")
```


## Data

```{r}
df <- read_csv("../data-clean/left-palas-redcap.csv") %>%
  mutate(weekday = factor(weekday, levels = paste0(c("Mon", "Tues", "Wednes", "Thurs", "Fri"), "day")),
         intervention = factor(intervention, levels = c("Mask mandate", "No intervention", "Air cleaner")),
         n_room = n_room / n_class)
  

df_daily <- df %>%
  group_by(school, date, week, weekday, intervention, maskmandate, airfilter) %>%
  summarize(across(c(co2ppm, rh, cn1cm, pmtotmugm, pm1mugm, pm25mugm, pm4mugm,
                     pm10mugm, vocmgm, rav, n_room), ~ mean(.x, na.rm = T))) %>%
  ungroup() %>%
  group_by(school) %>%
  arrange(date) %>%
  mutate(day = 1:n()) %>%
  ungroup()

df_daily_within <- df_daily %>%
  group_by(school, weekday) %>%
  mutate(across(c(co2ppm, rh, cn1cm, pmtotmugm, pm1mugm, pm25mugm, pm4mugm,
                     pm10mugm, vocmgm, rav, n_room), ~ (.x - mean(.x)) / sd(.x))) %>%
  ungroup() 

vars <- c("co2ppm", "rh", "rav", "cn1cm", "pmtotmugm", "pm1mugm", "pm25mugm", "pm4mugm")
vars_labels <- c("CO[2]~(ppm)", "RH~('%')", "RAV~(l/min)", "CN~(1/cm^3)", 
                 "PM[Total]~(mu*gm^{-3})", "PM[1]~(mu*gm^{-3})", "PM[2.5]~(mu*gm^{-3})", "PM[4]~(mu*gm^{-3})")
names(vars_labels) <- vars
vars_labels_no_units <- c("CO[2]", "RH", "RAV", "CN", "PM[Total]", "PM[1]", "PM[2.5]", "PM[4]")
names(vars_labels_no_units) <- vars
```


## Descriptives

```{r}
df_daily %>%
  group_by(intervention) %>%
  summarise(across(c(co2ppm, cn1cm), ~ paste(round(mean(.x)), round(sd(.x)), sep = " +/- ")),
            across(c(pm1mugm, pm4mugm), ~ paste(round(mean(.x), 1), round(sd(.x), 1), sep = " +/- ")))

boxplots <- df_daily %>%
  select(school, intervention, co2ppm, rh, rav, cn1cm, pmtotmugm, pm1mugm, pm25mugm, pm4mugm) %>%
  melt(c("school", "intervention")) %>%
  ggplot(aes(color = intervention, y = value, x = school)) +
  facet_wrap(~ variable, scales = "free_y", ncol = 2, labeller = as_labeller(vars_labels, label_parsed)) +
  geom_boxplot(outlier.size = 1) +
  scale_color_manual(values = intervention_col) +
  labs(color = "Intervention") +
  theme_bw2() +
  theme(legend.position = "top", axis.title = element_blank(), 
        legend.title = element_blank())

boxplots

save_plot(boxplots, "../results/palas-supp-descriptives.pdf", w = 16, h = 14)

boxplots_main <- df_daily %>%
  select(school, intervention, co2ppm, cn1cm, pm1mugm, pm4mugm) %>%
  melt(c("school", "intervention")) %>%
  ggplot(aes(color = intervention, y = value, x = variable)) +
  facet_wrap(~ variable, scales = "free", nrow = 1, labeller = as_labeller(vars_labels, label_parsed)) +
  geom_boxplot(outlier.size = 1) +
  scale_color_manual(values = intervention_col) +
  labs(color = "Intervention", title = "a") +
  theme_bw2() +
  theme(legend.position = "top", axis.title = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank(),
        legend.title = element_blank())

boxplots_main

save_plot(boxplots_main, "../results/palas-descriptives.pdf", w = 16, h = 5)
```

## Linear models

```{r}
seed0 <- 12345

# Results
# coefs <- list()
# intervals <- list()
draws <- list()

for (i in 1:length(vars)) {
  f <- as.formula(paste0(vars[[i]], "~ intervention + school + n_room"))
  m <- stan_glm(f, data = df_daily_within %>% 
                  mutate(intervention = factor(intervention, levels = c("No intervention", "Mask mandate", "Air cleaner"))), 
                seed = seed0)
  draws[[i]] <- as.data.frame(m)
}


draws_filt <- do.call(rbind, draws) %>%
  mutate(outcome = factor(rep(vars, each = nrow(draws[[i]])), levels = rev(vars))) %>%
  set_names(c("Interceot", "Mask mandate", "Air cleaner", "School", "InClass", "Sigma", "outcome")) %>%
  select(outcome, `Mask mandate`, `Air cleaner`) %>%
  melt("outcome") 

# all for supplements
effects_env <- draws_filt %>%
  mutate(outcome = recode(as.character(outcome), !!! vars_labels_no_units),
         outcome = factor(outcome, levels = rev(vars_labels_no_units))) %>%
  ggplot(aes(y = outcome, color = variable, x = value)) +
  stat_pointinterval(point_interval = "mean_qi", position = position_dodge(width = .5), fill = "white", shape = 21, .width = c(.5, .8, .95)) +
  labs(color = "Intervention", x = "Estimated change in z-score") +
  scale_color_manual(values = cbPalette) +
  scale_y_discrete(labels = scales::parse_format()) +
  geom_vline(aes(xintercept = 0), linetype = "dotted") +
  theme_bw2() +
  theme(axis.title.y = element_blank(), legend.position = "top", legend.title = element_blank())

effects_env

save_plot(effects_env, "../results/palas-supp-results.pdf", w = 12, h = 11)

# supplementary table
effects_tbl <- draws_filt %>%
  mutate(outcome = recode(as.character(outcome), !!! vars_labels_no_units),
         outcome = factor(outcome, levels = rev(vars_labels_no_units))) %>%
  rename(intervention = variable) %>%
  group_by(outcome, intervention) %>%
  mean_qi() %>%
  ungroup() %>%
  filter(.width == .95) %>%
  select(outcome, intervention, value, .lower, .upper) %>%
  melt(c("outcome", "intervention")) %>%
  dcast(outcome ~ intervention + variable) %>%
  mutate_if(is.numeric, round_k) %>%
  mutate(across(-outcome, tex_sign)) %>%
  arrange(-row_number()) %>%
  mutate(outcome = c("CO$_2$", "RH", "RAV", "CN", 
                     "PM$_{\\text{Total}}$", "PM$_{1}$", "PM$_{2.5}$", "PM$_{4}$"),
         space = "") %>%
  select(outcome, matches("Mask"), space, matches("Air")) %>%
  as.matrix() %>%
  xtable() %>%
  print.xtable(
    file = "../results/palas-supp-estimation-results.tex",
    type = "latex",
    sanitize.text.function = identity,
    include.colnames = F,
    include.rownames = F,
    only.contents = T,
    hline.after = NULL)



# selected for manuscript
effects_env_main <- draws_filt %>%
  filter(outcome %in% c("co2ppm", "cn1cm", "pm1mugm", "pm4mugm")) %>%
  mutate(outcome = factor(outcome, levels = (c("co2ppm", "cn1cm", "pm1mugm", "pm4mugm")))) %>%
  ggplot(aes(y = variable, color = variable, x = value)) +
  stat_pointinterval(point_interval = "mean_qi", fill = "white", shape = 21, .width = c(.5, .8, .95)) +
  facet_wrap(~ outcome, nrow = 1, labeller = as_labeller(vars_labels_no_units, label_parsed)) +
  labs(color = "Intervention", x = "Estimated change in z-score", title = "b") +
  scale_color_manual(values = cbPalette) +
  geom_vline(aes(xintercept = 0), linetype = "dotted") +
  theme_bw2() +
  theme(axis.title.y = element_blank(), legend.position = "top", axis.ticks.y = element_blank(), axis.text.y = element_blank(),
        legend.title = element_blank())

effects_env_main

save_plot(effects_env_main, "../results/palas-results.pdf", w = 16, h = 5)
```
