---
title: "Palas"
author: "NB"
date: "2022-08-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
library(tidyverse)
library(reshape2)
library(lubridate)
library(lme4)
library(texreg)
```

## Data

```{r}
df <- read_csv("../data-clean/palas-all.csv")
df_class <- read_csv("../data-clean/palas-class.csv")
df_merge <- read_csv("../data-clean/merged-data.csv")
```

```{r}
df_merge_md <- df_merge %>%
  select(location, day, intervention, co2ppm, rh, cn1cm, pmtotmugm, vocmgm, rav) %>%
  group_by(location, day) %>%
  mutate(across(-intervention, ~ .x - mean(.x, na.rm = T))) %>%
  ungroup()
```

```{r}
n_time_class_weighted <- function(n, C) {
  G <- unique(C)
  tG <- c()
  nG <- c()
  for (i in 1:length(G)) {
    tG[i] <- length(n[C==G[i]])
    nG[i] <- n[C==G[i]][i]
  }
  sum(tG * nG) / sum(tG)
}

df_merge_mean <- df_merge %>%
  filter(!no_class) %>%
  mutate(n_in_class = n_class - n_tot_absent) %>%
  group_by(location, date) %>%
  summarize(across(c(week, day, intervention), ~ .x[1]),
            across(c(co2ppm, rh, cn1cm, pmtotmugm, pm1mugm, pm25mugm, pm4mugm,
                     pm10mugm, vocmgm, rav), ~ mean(.x, na.rm = T)),
            n_in_class = n_time_class_weighted(n_in_class, class)) %>%
  ungroup() %>%
  mutate(day = factor(day, levels = c("Montag", "Dienstag", "Mittwoch", "Donnerstag",
                                      "Freitag")),
         location = factor(location, levels = c("olten", "trimbach")),
         intervention = factor(intervention, levels = c("No", "Mask mandate", "Air filter")))
```


## In class absolute

### CO2

```{r}
df_merge %>%
  ggplot(aes(x = intervention, y = co2ppm, color = intervention)) +
  geom_boxplot() +
  facet_wrap(~ location)
```


```{r}
co2_lm <- lm(co2ppm ~ intervention + day + n_in_class + location, data = df_merge_mean)
```

### Humidity 

```{r}
df_class %>%
  ggplot(aes(x = intervention, y = rh, color = intervention)) +
  geom_boxplot() +
  facet_wrap(~ location)
```

```{r}
rh_lm <- lm(rh ~ intervention + day + n_in_class + location, data = df_merge_mean)
```


### Aerosol conentration

```{r}
df_class %>%
  ggplot(aes(x = intervention, y = cn1cm, color = intervention)) +
  geom_boxplot() +
  facet_wrap(~ location)
```


```{r}
cn1cm_lm <- lm(cn1cm ~ intervention + day + n_in_class + location, data = df_merge_mean)
```


### Particle matter concentration

```{r}
df_class %>%
  ggplot(aes(x = intervention, y = pmtotmugm, color = intervention)) +
  geom_boxplot() +
  facet_wrap(~ location)
```

```{r}
pmtotmugm_lm <- lm(pmtotmugm ~ intervention + day + n_in_class + location, data = df_merge_mean)
pm1mugm_lm <- lm(pm1mugm ~ intervention + day + n_in_class + location, data = df_merge_mean)
pm25mugm_lm <- lm(pm25mugm ~ intervention + day + n_in_class + location, data = df_merge_mean)
pm4mugm_lm <- lm(pm4mugm ~ intervention + day + n_in_class + location, data = df_merge_mean)
pm10mugm_lm <- lm(pm10mugm ~ intervention + day + n_in_class + location, data = df_merge_mean)
```

```{r}
df_class %>%
  select(location, intervention, pm1mugm, pm25mugm, pm4mugm, pm10mugm) %>%
  melt(c("location", "intervention")) %>%
  ggplot(aes(x = variable, y = value, color = intervention)) +
  geom_boxplot(position = position_dodge()) +
  facet_wrap(~ location)
```


### Volatile organic compound matter mass concentration

```{r}
df_class %>%
  ggplot(aes(x = intervention, y = vocmgm, color = intervention)) +
  geom_boxplot() +
  facet_wrap(~ location)
```

```{r}
vocmgm_lm <- lm(vocmgm ~ intervention + day + n_in_class + location, data = df_merge_mean)
```


### Rebreated air volume

```{r}
df_merge %>%
  ggplot(aes(x = intervention, y = rav, color = intervention)) +
  geom_boxplot() +
  facet_wrap(~ location)
```

```{r}
rav_lm <- lm(rav ~ intervention + day + n_in_class + location, data = df_merge_mean)
```


### Summary

```{r}
htmlreg(list(co2_lm, rh_lm, cn1cm_lm, pm1mugm_lm, pm25mugm_lm, pm4mugm_lm, pm10mugm_lm,
             vocmgm_lm, rav_lm),
        file = "../results/linear-models-palas.html",
        custom.coef.names = c("Intercept", "Mask mandate", "Air filter",
                              "Dienstag", "Mittwoch", "Donnerstag", "Freitag",
                              "No. in class", "Trimbach"),
        custom.model.names = c("CO2", "rH", "Cn",
                               "PM 1", "PM 2.5", "PM 4", "PM 10", "VOC", "RAV"),
        caption = "Intervention effects on environmental variables",
        caption.above = T,
        bold = 0.05,
        custom.note = "CO2: carbon dioxide (ppm), 
        rH: relative humidity (%), 
        Cn: aerosol concentration (1/cm3), 
        PM: particle matter mass concentration 1, 2.5, 4, and 10 (mug/m3), 
        VOC: volatile organic compounds matter mass concentration (mg/m3), 
        RAV: rebreathed air volume (l/min). 
        <br> %stars.")
```


## In class mean diff

### CO2

```{r}
df_merge_md %>%
  ggplot(aes(x = intervention, y = co2ppm, color = intervention)) +
  geom_boxplot() +
  geom_hline(aes(yintercept = 0), linetype = "dashed") +
  facet_wrap(~ location)
```

### Humidity 

```{r}
df_merge_md %>%
  ggplot(aes(x = intervention, y = rh, color = intervention)) +
  geom_boxplot() +
  geom_hline(aes(yintercept = 0), linetype = "dashed") +
  facet_wrap(~ location)
```


### Aerosol conentration

```{r}
df_merge_md %>%
  ggplot(aes(x = intervention, y = cn1cm, color = intervention)) +
  geom_boxplot() +
  geom_hline(aes(yintercept = 0), linetype = "dashed") +
  facet_wrap(~ location)
```


### Particle matter concentration

```{r}
df_merge_md %>%
  ggplot(aes(x = intervention, y = pmtotmugm, color = intervention)) +
  geom_boxplot() +
  geom_hline(aes(yintercept = 0), linetype = "dashed") +
  facet_wrap(~ location)
```


### Volatile organic compound matter mass concentration

```{r}
df_merge_md %>%
  ggplot(aes(x = intervention, y = vocmgm, color = intervention)) +
  geom_boxplot() +
  geom_hline(aes(yintercept = 0), linetype = "dashed") +
  facet_wrap(~ location)
```


### Rebreated air volume

```{r}
df_merge_md %>%
  ggplot(aes(x = intervention, y = rav, color = intervention)) +
  geom_boxplot() +
  geom_hline(aes(yintercept = 0), linetype = "dashed") +
  facet_wrap(~ location)
```
