---
title: "Palas"
author: "NB"
date: "2022-08-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
library(tidyverse)
library(tidybayes)
library(reshape2)
library(lubridate)
library(rstanarm)
library(texreg)
library(gridExtra)
library(ggpubr)
library(ggridges)
library(xtable)

source("../utils/plotting.R")
source("../utils/tex.R")
```


## Data

```{r}
df <- read_csv("../data-clean/left-palas-redcap.csv") %>%
  mutate(weekday = factor(weekday, levels = paste0(c("Mon", "Tues", "Wednes", "Thurs", "Fri"), "day")),
         intervention = factor(intervention, levels = c("None", "Mask mandate", "Air filter")),
         n_room = n_room / n_class)
  

df_daily <- df %>%
  group_by(school, date, week, weekday, intervention, maskmandate, airfilter) %>%
  summarize(across(c(co2ppm, rh, cn1cm, pmtotmugm, pm1mugm, pm25mugm, pm4mugm,
                     pm10mugm, vocmgm, rav, n_room), ~ mean(.x, na.rm = T))) %>%
  ungroup() %>%
  group_by(school) %>%
  arrange(date) %>%
  mutate(day = 1:n()) %>%
  ungroup()

df_daily_within <- df_daily %>%
  group_by(school, weekday) %>%
  mutate(across(c(co2ppm, rh, cn1cm, pmtotmugm, pm1mugm, pm25mugm, pm4mugm,
                     pm10mugm, vocmgm, rav, n_room), ~ (.x - mean(.x)) / sd(.x))) %>%
  ungroup() 

vars <- c("co2ppm", "rh", "rav", "cn1cm", "pmtotmugm", "pm1mugm", "pm25mugm", "pm4mugm")
vars_labels <- c("CO[2]~(ppm)", "RH~('%')", "RAV~(l/min)", "CN~(1/cm^3)", 
                 "PM[Total]~(mu*gm^{-3})", "PM[1]~(mu*gm^{-3})", "PM[2.5]~(mu*gm^{-3})", "PM[4]~(mu*gm^{-3})")
names(vars_labels) <- vars
vars_labels_no_units <- c("CO[2]", "RH", "RAV", "CN", "PM[Total]", "PM[1]", "PM[2.5]", "PM[4]")
names(vars_labels_no_units) <- vars
```


## Descriptives

```{r}
boxplots <- df_daily %>%
  select(school, intervention, co2ppm, rh, rav, cn1cm, pmtotmugm, pm1mugm, pm25mugm, pm4mugm) %>%
  melt(c("school", "intervention")) %>%
  ggplot(aes(color = intervention, y = value, x = school)) +
  facet_wrap(~ variable, scales = "free_y", ncol = 2, labeller = as_labeller(vars_labels, label_parsed)) +
  geom_boxplot(outlier.size = 1) +
  scale_color_manual(values = c("black", cbPalette[1:2])) +
  labs(color = "Intervention") +
  theme_bw2() +
  theme(legend.position = "bottom", axis.title = element_blank())

boxplots

save_plot(boxplots, "../results/palas-descriptives.pdf", w = 16, h = 18)
```

## Linear models

```{r}
seed0 <- 12345

# Results
coefs <- list()
intervals <- list()
draws <- list()

for (i in 1:length(vars)) {
  f <- as.formula(paste0(vars[[i]], "~ intervention + school + n_room"))
  m <- stan_glm(f, data = df_daily_within, seed = seed0)
  coefs[[i]] <- c(tex_sign(round_k(coef(m)["interventionMask mandate"])), tex_sign(round_k(coef(m)["interventionAir filter"])))
  ci95 <- posterior_interval(m)
  ci95_mask <- sapply(ci95[row.names(ci95) == "interventionMask mandate"], function(x) tex_sign(round_k(x)))
  ci95_mask <- paste0("[", ci95_mask[1], "; ", ci95_mask[2], "]")
  ci95_air <- sapply(ci95[row.names(ci95) == "interventionAir filter"], function(x) tex_sign(round_k(x)))
  ci95_air <- paste0("[", ci95_air[1], "; ", ci95_air[2], "]")
  intervals[[i]] <- c(ci95_mask, ci95_air)
  draws[[i]] <- as.data.frame(m)
}

# Figure
draws_filt <- do.call(rbind, draws) %>%
  mutate(outcome = factor(rep(vars, each = nrow(draws[[i]])), levels = rev(vars))) %>%
  set_names(c("Interceot", "Mask mandate", "Air filter", "School", "InClass", "Sigma", "outcome")) %>%
  select(outcome, `Mask mandate`, `Air filter`) %>%
  melt("outcome") %>%
  mutate(outcome = recode(as.character(outcome), !!! vars_labels_no_units),
         outcome = factor(outcome, levels = rev(vars_labels_no_units))) 

effects_env <- draws_filt %>%
  ggplot(aes(y = outcome, color = variable, x = value)) +
  stat_pointinterval(position = position_dodge(width = .5), fill = "white", shape = 21) +
  labs(color = "Intervention", x = "Estimated change in z-score") +
  scale_color_manual(values = cbPalette) +
  scale_y_discrete(labels = scales::parse_format()) +
  geom_vline(aes(xintercept = 0), linetype = "dotted") +
  theme_bw2() +
  theme(axis.title.y = element_blank(), legend.position = "bottom")

effects_env

save_plot(effects_env, "../results/palas-results.pdf", w = 12, h = 11)
```
