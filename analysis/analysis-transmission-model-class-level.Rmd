---
title: "Transmission Modeling"
author: "NB"
date: "2022-09-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
library(tidyverse)
library(cmdstanr)
library(reshape2)
library(lubridate)

source("../utils/epi.r")
source("../utils/bayes.R")
source("../utils/plotting.R")
source("../utils/tex.R")
```


## Data

```{r}
col_order <- c("School 1 Study (A)", "School 1 Study (B)", "School 1 Control", "School 2 Study", "School 2 Control")
names(col_order) <- 1:5
J <- length(col_order)

r_est <- read_csv("../data-clean/r-estimates.csv")

df <- read_csv("../data-clean/redcap.csv") %>%
  filter(!no_school) %>%
  mutate(new_cases = new_confirmed + new_symptomatic + new_unknown,
         cum_cases = cum_confirmed + cum_symptomatic + cum_unknown,
         prop_absences = n_tot_absent / n_class) %>%
  rename(absences = n_tot_absent) %>%
  group_by(school, class) %>%
  arrange(date) %>%
  mutate(day = 1:n()) %>%
  ungroup() %>%
  left_join(r_est)  %>%
  mutate(class = factor(paste(school, class), levels = col_order))
```

```{r}
# Intervention dates
maskmandate_dates <- df %>%
  group_by(school, class) %>%
  arrange(date) %>%
  filter(intervention == "None") %>%
  slice(1) %>%
  ungroup() %>%
  select(school, class, date, day) %>%
  mutate(day = day -1,
         intervention = "Mask\nmandate")

airfilter_dates <- df %>%
  group_by(school, class) %>%
  arrange(date) %>%
  filter(intervention == "Air filter") %>%
  slice(1) %>%
  ungroup() %>%
  select(school, class, date, day) %>%
  mutate(intervention = "Air\nfilter")

intervention_dates <- rbind(maskmandate_dates, airfilter_dates) %>%
  mutate(start_day = ifelse(intervention == "Mask\nmandate", -Inf, day),
         end_day = ifelse(intervention == "Air\nfilter", Inf, day),
         intervention = factor(intervention, levels = c("Mask\nmandate", "Air\nfilter")),
         x = ifelse(intervention == "Mask\nmandate", 7, 45)) 
```


## Descriptives

```{r}
df %>%
  select(school, class, day, cum_cases, n_class) %>%
  melt(c("school", "class", "day")) %>%
  ggplot(aes(x = day, y = value, color = class, linetype = variable)) +
  geom_path() +
  facet_wrap(~ school) +
  scale_y_continuous(expand= expansion(add = c(0,0.5))) +
  scale_x_continuous(expand = c(0,0))

df %>%
  ggplot(aes(x = new_cases)) +
  geom_histogram()
  

df %>%
  select(school, class, day, prop_absences) %>%
  melt(c("school", "class", "day")) %>%
  ggplot(aes(x = day, y = value, color = class)) +
  geom_line() +
  facet_wrap(~ school) +
  scale_y_continuous(expand= c(0,0), limits = c(0,1)) +
  scale_x_continuous(expand = c(0,0))

df %>%
  ggplot(aes(x = prop_absences)) +
  geom_histogram()

r_est %>%
  filter(between(date, min(df$date), max(df$date))) %>%
  ggplot(aes(x = date)) +
  geom_line(aes(y = median_R_mean)) +
  geom_line(aes(y = median_R_mean + median_R_SD), linetype = "dashed") +
  geom_line(aes(y = median_R_mean - median_R_SD), linetype = "dashed") +
  geom_vline(data = intervention_dates, mapping = aes(xintercept = date), linetype = "dotted", color = "red") +
  geom_hline(aes(yintercept = 1.0), linetype = "dotted", color = "blue")
```


## Simulation


```{r}
set.seed(12345)

S <- 12
D <- 52 + S
pop <- 24
pin <- vp(D+S, F, p_in)
alpha <- -4


newI <- c()
newN <- c()
SU <- c()
cumI <- c()
cumN <- c()

for (i in 1:1) {
  newI[1] <- rexp(1, 1)
  cumI[1] <- newI[1]
  SU[1] <- pop - cumI[1]
  newN[1] <- sum(newI[1] * tail(rev(pin), 1))
  cumN[1] <- newN[1]
  for (d in 2:D) {
    newI[d] <- invlogit(alpha) * SU[d-1]
    cumI[d] <- cumI[d-1] + newI[d]
    SU[d] <- pop - cumI[d]
    newN[d] <- sum(newI[1:d] * tail(rev(pin), d))
    cumN[d] <- cumN[d-1] + newN[d]
  }
}

simDat <- data.frame(day = 1:D,
                     infections = cumI,
                     cases = cumN,
                     susceptibles = SU)

simDat %>%
  melt("day") %>%
  ggplot(aes(x = day, y = value, color = variable)) +
  geom_line()
```

## Prior

### Suspected cases

Multiplier:
Minimum = pmax(Total / Population, 1) 
--> corresponds to all possible suspected cases being actual cases: Min = pmin(population - confirmed, suspected)
--> Multiplier = Total / (Min + Confirmed)

Maximum = Total / Confirmed 
--> corresponds to no suspected cases being actual cases: 0
--> Multiplier = Total / (Max + Confirmed)


```{r}
# excessive cases
total_cases <-  df %>%
  select(class, n_class, cum_confirmed, cum_symptomatic, cum_unknown) %>%
  group_by(class) %>%
  summarize(all = max(cum_confirmed + cum_symptomatic + cum_unknown),
            confirmed = max(cum_confirmed),
            suspected = max(cum_symptomatic + cum_unknown),
            pop = max(n_class)) %>%
  ungroup() 

pnorm.lim <- function(l, u, ...) {
  k <- seq(l, u, .01)
  data.frame(k=k, p=sapply(k, dnorm, ...))
}

exc_df <- total_cases %>%
  mutate(upper = pmin(pop - confirmed, suspected),
         lower = 0) %>%
  rowwise() %>%
  mutate(mu = (upper + lower) / 2,
         sigma = (upper - lower) / (2*qnorm(0.95)),
         draws = list(pnorm.lim(lower, upper, mu, sigma))) %>%
  unnest() %>%
  mutate(k = k / suspected,
         mu = mu / suspected) 

exc_df_limits <- exc_df %>%
  group_by(class) %>%
  filter(k == min(k) | k == max(k)) %>%
  ungroup()

exc_df_pl <- exc_df %>%
  ggplot(aes(ymin = -Inf, ymax = p, x = k)) +
  facet_wrap(~ class, nrow = 1) +
  geom_ribbon(alpha = .1) +
  geom_line(aes(y = p)) +
  geom_segment(data = exc_df_limits, mapping = aes(x = k, xend = k, y = 0, yend = p), linetype = "dashed") +
  geom_vline(aes(xintercept = mu), linetype = "dotted", color = "blue") +
  scale_x_continuous(expand = expansion(add = c(0,0)), limits = c(0,1), labels = function(x) x * 100) +
  scale_y_continuous(expand = expansion(add = c(0., .01)), limits = c(0, NA)) +
  labs(x = "Proportion of suspected cases being actual cases of COVID-19 (%)", 
       y = "Density") +
  theme_bw2() +
  theme(plot.title = element_text(hjust = 0), panel.spacing = unit(1, "lines"),
        plot.margin = unit(c(0.1, .5, 0.1, 0.1), "cm"))

exc_df_pl

save_plot(exc_df_pl, pdf_file = "../results/redcap-prior-excessive-cases.pdf", w = 16, h = 4)
```

### Incubation period

```{r}
prior_pin_mu_pl <- data.frame(x = seq(1.33,1.93,.01)) %>%
  mutate(y = dnorm(x, p_in_mu_m, p_in_mu_s)) %>%
  ggplot(aes(x = x, y = y)) +
  geom_line() +
  geom_vline(aes(xintercept = p_in_mu_m), linetype = "dotted", color = "blue") +
  labs(x = expression("log "*mu*" of "*p[IN]), y = "Density", title = "a") +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = expansion(mult = c(0,0.05))) +
  theme_bw2() +
  theme(plot.title = element_text(hjust = 0))

prior_pin_mu_pl

prior_pin_sigma_pl <- data.frame(x = seq(0.3, 0.7, 0.01)) %>%
  mutate(y = dnorm(x, p_in_sigma_m, p_in_sigma_s)) %>%
  ggplot(aes(x = x, y = y)) +
  geom_line() +
  geom_vline(aes(xintercept = p_in_sigma_m), linetype = "dotted", color = "blue") +
  labs(x = expression("log "*sigma*" of "*p[IN]), y = "Density", title = "b") +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = expansion(mult = c(0,0.05))) +
  theme_bw2() +
  theme(plot.title = element_text(hjust = 0))

prior_pin_sigma_pl


set.seed(12345)

prior_pin <- data.frame(
  lmu = rnorm(4e3, p_in_mu_m, p_in_mu_s),
  lsigma = rnorm(4e3, p_in_sigma_m, p_in_sigma_s)
) %>%
  mutate(pin = map2(lmu, lsigma, function(log_mu, log_sigma) data.frame(x = 0:15, y = vp(15, T, p_in, log_mu, log_sigma)))) %>%
  unnest() 

prior_pin_pl <- prior_pin %>%
  ggplot(aes(x = x, y = y)) +
  stat_lineribbon() +
  scale_fill_brewer() + 
  labs(x = "s (delay in days)", y = expression(p[IN]*" (probability in %)")) +
  ggtitle("c") +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = expansion(mult = c(0,0.05))) +
  theme_bw2() +
  theme(plot.title = element_text(hjust = 0), legend.position = "none")

prior_pin_pl

comb_prior_pin_pl <- arrangeGrob(prior_pin_mu_pl, prior_pin_sigma_pl, prior_pin_pl, widths = c(5.33, 5.33, 5.33), ncol = 3)

ggsave(plot = comb_prior_pin_pl, filename = "../results/redcap-supp-prior-pin.pdf", width = 16 / cm(1), height = 5 / cm(1))
```


### Seeding phase

```{r}
S <- round(exp(p_in_mu_m + p_in_sigma_m^2 / 2)) * 2
```


### Alpha

```{r}
Tdays <- nrow(df) / 5 + S
#' (1 - x) ^ Tdays = mean_share
#' Tdays * log 1-x = log (mean_share)
#' log 1-x = log (mean_share) / Tdays
#' x = 1 - exp(log (mean_share) / Tdays)

share_of_susecptibles <- exc_df %>%
  mutate(share_end = 1 - (suspected * k + confirmed) / pop,
         daily_share = 1 - exp(log(share_end) / Tdays),
         logit_daily_share = logit(daily_share)) %>%
  select(class, mu, share_end, daily_share, logit_daily_share) 
  

mean_share <- mean(share_of_susecptibles$share_end)
mean_share

mean_daily_share = 1 - exp(log(mean_share) / Tdays)
logit(mean_daily_share)

daily_share_pl <- share_of_susecptibles %>%
  ggplot(aes(x = daily_share)) +
  geom_density() +
  geom_vline(aes(xintercept = median(share_of_susecptibles$daily_share)), linetype = "dotted", color = "blue") + 
  scale_y_continuous(expand = expansion(mult = c(0,0.05))) +
  scale_x_continuous(limits = c(0, .1), labels = function(x) x * 100, expand = c(0,0)) +
  labs(x = "Daily proportion of\nsusceptibles getting infected", y = "Density", title = "a") +
  theme_bw2() +
  theme(plot.title = element_text(hjust = 0))

daily_share_pl

prior_logit_share <- data.frame(x = seq(-8, 0, .1)) %>%
  mutate(y = LaplacesDemon::dst(x, mu = -4, sigma = 1.5, nu = 3))
  
logit_daily_share_pl <- share_of_susecptibles %>%
  ggplot(aes(x = logit_daily_share)) +
  geom_density() +
  geom_line(data = prior_logit_share, mapping = aes(x = x, y = y), color = "red") +
  annotate("text", x = -1.5, y = 0.15, label = "Prior", color = "red", size = 8 / cm(1)) +
  geom_vline(aes(xintercept = median(share_of_susecptibles$logit_daily_share)), linetype = "dotted", color = "blue") + 
  scale_y_continuous(expand = expansion(mult = c(0,0.05))) +
  scale_x_continuous(expand = c(0,0)) +
  labs(x = "Logit of the daily proportion of\nsusceptibles getting infected", y = "Density", title = "b") +
  theme_bw2() +
  theme(plot.title = element_text(hjust = 0))

logit_daily_share_pl

comb_prior_pl <- arrangeGrob(daily_share_pl, logit_daily_share_pl, widths = c(5, 5), ncol = 2)

ggsave(plot = comb_prior_pl, filename = "../results/redcap-supp-prior-alpha.pdf", width = 10 / cm(1), height = 5 / cm(1))
```


## Results

```{r}
meta_dat <- data.frame(folders = list.files("../fitted-models/multiverse", full.names = T),
                       dataset = as.numeric(list.files("../fitted-models/multiverse"))) %>%
  arrange(dataset) %>%
  mutate(avoided_file = sapply(folders, list.files, pattern = "avoided", full.names = T),
         inc_file = sapply(folders, list.files, pattern = "incidence", full.names = T),
         sample_file = sapply(folders, list.files, pattern = "sample", full.names = T),
         results_file = sapply(folders, list.files, pattern = "estimation_results", full.names = T))

a=sapply(meta_dat$folders, list.files, pattern = "estimation")
```

### Estimation results

```{r}
est_results <- meta_dat %>%
  mutate(data = lapply(results_file, readRDS)) %>%
  unnest() %>%
  select(variable, mean, median, sd, mad, q5, q95, rhat, ess_bulk, ess_tail) %>%
  group_by(variable) %>%
  summarize_all(mean) %>%
  ungroup() %>%
  mutate_if(is.numeric, function(x) tex_sign(round_k(x)))

variable <- c("phi_N", paste0("alpha[", 1:J, "]"), "mu_p_in", "sigma_p_in", 
              "theta_M", "tau", paste0("theta_l[",1:J,"]"),"theta_A",
              "gamma[1]", "gamma[2]")
variable_name <- c("$\\phi$", 
                   "$\\alpha_{\\textrm{School 1 Study (A)}}$", 
                   "$\\alpha_{\\textrm{School 1 Study (B)}}$",
                   "$\\alpha_{\\textrm{School 1 Control}}$", 
                   "$\\alpha_{\\textrm{School 2 Study}}$", 
                   "$\\alpha_{\\textrm{School 2 Control}}$",
                   "$\\mu^{p_{IN}}$", "$\\sigma^{p_{IN}}$", 
                   "$\\theta^M$", "$\\tau$",
                   "$\\theta^M_{\\textrm{School 1 Study (A)}}$", 
                   "$\\theta^M_{\\textrm{School 1 Study (B)}}$",
                   "$\\theta^M_{\\textrm{School 1 Control}}$", 
                   "$\\theta^M_{\\textrm{School 2 Study}}$", 
                   "$\\theta^M_{\\textrm{School 2 Control}}$",
                   "$\\theta^A$", "$\\gamma^{\\textrm{Absences}}$", 
                   "$\\gamma^{\\textrm{Community} R_t}$")
names(variable_name) <- variable

est_results <- est_results %>%
  mutate(parameter = variable,
         parameter = recode(variable, !!! variable_name),
         parameter = factor(parameter, levels = variable_name)) %>%
  select(parameter, mean, q5, q95, rhat, ess_bulk) %>%
  arrange(parameter) %>%
  as.matrix() 

xtable::print.xtable(xtable::xtable(est_results),
                     type = "latex",
                     file = "../results/redcap-supp-estimation-results.tex",
                     sanitize.text.function = identity,
                     include.colnames = F,
                     include.rownames = F,
                     only.contents = T,
                     hline.after = NULL)
```

### Cumulative infections

```{r}
# Example
ex <- 1
path_ex <- paste0("../fitted-models/multiverse/", ex, "/")
example <- cmdstanr::read_cmdstan_csv(list.files(path_ex, pattern = "tm_class", full.names = T))

comp_I <- gather_draws_csv2(example, "mu_cum_infections", 1, nrow(df) / length(col_order) + S, 1, length(col_order)) %>%
  mutate(variable = "Infections") 

comp_N <- gather_draws_csv2(example, "mu_cum_cases", 1, nrow(df) / length(col_order) + S, 1, length(col_order)) %>%
  mutate(variable = "Cases") 

comp_S <- gather_draws_csv2(example, "susceptibles", 1, nrow(df) / length(col_order) + S, 1, length(col_order)) %>%
  mutate(variable = "Susceptibles") 

est_comp <- rbind(comp_I, comp_N, comp_S) %>%
  rename(day = row, 
         class = col) %>%
  mutate(class = recode(as.numeric(class), !!! col_order),
         class = factor(class, levels = col_order),
         day = as.numeric(day) - S) %>%
  select(-.draw, -.chain, -.iteration) %>%
  group_by(class, day, variable) %>%
  mean_qi() %>%
  ungroup() %>%
  mutate(type = "Estimated")

df_wSeed <- readRDS(paste0(path_ex, "sample.rds")) %>%
  select(class, day, cum_cases) %>%
  rename(value = cum_cases) %>%
  left_join(est_comp %>%
    select(class, day, variable, value) %>%
    filter(variable == "Cases") %>%
    filter(day == 1) %>%
    mutate(value = round(value),
           type = "Observed") %>%
    rename(seed_value = value) %>%
    select(-day)) %>%
  mutate(value = value + seed_value) 

cum_inc_pl <- ggplot(mapping = aes(x = day)) +
  geom_line(data = est_comp, mapping = aes(y = value, color = variable, linetype = type), size = 1) +
  geom_ribbon(data = est_comp, mapping = aes(ymin = .lower, ymax = .upper, fill = variable), alpha = .2) +
  geom_line(data = df_wSeed, mapping = aes(y = value, color = variable, linetype = type), size = 1) +
  geom_vline(data = intervention_dates, mapping = aes(xintercept = day), linetype = "dotted") +
  geom_vline(data = data.frame(x=1), mapping = aes(xintercept = x), linetype = "dotted", color = "red") +
  scale_fill_brewer(palette = "Accent") +
  scale_color_brewer(palette = "Accent") +
  facet_wrap(~ class) +
  scale_x_continuous(expand = c(0,0), breaks = c(-11, seq(1, 51, 10))) +
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Cumulative incidence", color = "", fill = "", linetype = "", title = "a") +
  theme_bw2() +
  theme(axis.title.x = element_blank(), legend.position = "bottom",
        panel.spacing = unit(1, "lines"), plot.title = element_text(hjust = 0))

cum_inc_pl
```

```{r}
# cumulative infections 95-CrI
cum_I_crI <- meta_dat %>%
  mutate(estimated_data = lapply(inc_file, readRDS)) %>%
  unnest() %>%
  filter(variable == "Cumulative cases") %>%
  filter(.width == "0.95") %>%
  select(inc_file, dataset, class, day, value, .lower, .upper)

# observations
cum_N_obs <- meta_dat %>%
  mutate(observed_data = lapply(sample_file, readRDS)) %>%
  unnest() %>%
  select(sample_file, dataset, class, day, cum_cases)

# coverage
coverage_df <- left_join(cum_I_crI, cum_N_obs) %>%
  mutate(is_in = ifelse(cum_cases >= .lower & cum_cases <= .upper, T, F)) %>%
  group_by(dataset) %>%
  summarise(coverage = sum(is_in) / n() * 100) %>%
  ungroup() %>%
  arrange(coverage) %>%
  mutate(order = n():1)

coverage_df_pl <- coverage_df %>%
  ggplot(aes(x = order, y = coverage)) +
  geom_line() +
  geom_point(shape = 4) +
  geom_hline(aes(yintercept = round(mean(coverage_df$coverage))), color = "blue", linetype = "dotted")  + 
  annotate("text", y = round(mean(coverage_df$coverage)) - 5, x = 15, 
           label = paste0("Average across datasets: ", round(mean(coverage_df$coverage))),
           size = 8 / cm(1), color = "blue") +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0), limits = c(0,100)) +
  labs(y = "Empirical coverage of the 95%-CrI by dataset (%)", title = "b") +
  theme_bw2() +
  theme(axis.text.x = element_blank(), axis.title.x = element_blank(), axis.ticks.x = element_blank(),
        plot.title = element_text(hjust = 0))

coverage_df_pl
```

```{r}
comb_inc_pl <- arrangeGrob(cum_inc_pl, coverage_df_pl, heights = c(10, 8), ncol = 1)

ggsave(plot = comb_inc_pl, filename = "../results/redcap-supp-results-incidence.pdf", width = 16 / cm(1), height = 18 / cm(1))
```

### Estimated Infections

```{r}
new_inc <- meta_dat %>%
  mutate(data = lapply(inc_file, readRDS)) %>%
  unnest() %>%
  filter(variable == "Infections") 

new_inc_mean <- new_inc %>%
  select(class, day, value) %>%
  group_by(class, day) %>%
  mean_qi() %>%
  ungroup()

est_I_pl <- ggplot(new_inc_mean, aes(x = day)) +
  geom_path(aes(y = value), color = RColorBrewer::brewer.pal(9, "Blues")[7]) +
  geom_ribbon(aes(ymin = .lower, ymax = .upper), fill = RColorBrewer::brewer.pal(9, "Blues")[7], alpha = .2) +
  facet_wrap(~ class) +
  geom_rect(data = intervention_dates, 
            mapping = aes(xmin = start_day, xmax = end_day, fill = intervention, ymin = -Inf, ymax = Inf), 
            alpha = .15) +
  geom_text(data = intervention_dates, aes(label = intervention, color = intervention, x = x, y = 1), size = 6 / cm(1)) +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  scale_fill_manual(values = cbPalette) +
  scale_color_manual(values = cbPalette) +
  labs(y = "Estimated number of new infections", color = "Intervention") +
  theme_bw2() +
  theme(axis.title.x = element_blank(), legend.position = "none",
        plot.title = element_text(hjust = 0)) 

est_I_pl

save_plot(est_I_pl, pdf_file = "../results/redcap-supp-results-infections.pdf", w = 16, h = 10)
```


### Avoided infections

```{r}
avoided_df <- meta_dat %>%
  mutate(data = lapply(avoided_file, readRDS)) %>%
  unnest() %>%
  mutate(variable = ifelse(variable == "Masks", "Mask mandate", "Air filter"),
         variable = factor(variable, levels = c("Mask mandate", "Air filter")))

avoided_df_sum <- avoided_df %>%
  select(dataset, variable, class, draw, value) %>%
  group_by(dataset, variable, draw) %>%
  summarize(value = sum(value)) %>%
  ungroup() %>%
  select(-draw) %>%
  group_by(dataset, variable) %>%
  mean_qi(.width = c(0.5, 0.8, 0.95)) %>%
  ungroup() %>%
  group_by(variable, .width) %>%
  summarise(value = median(value),
            .lower = median(.lower),
            .upper = median(.upper)) %>%
  ungroup() 

av_inf_tot_pl <- avoided_df_sum %>%
  arrange(desc(.width)) %>%
  ggplot(aes(xmin = .lower, xmax = .upper, ymin = 0, ymax = 2, fill = factor(.width, levels = rev(c(.5, .8, .95))))) +
  geom_rect() +
  geom_point(aes(x = value, y = 1), size = 4, fill = "white", shape = 21) +
  geom_vline(aes(xintercept = 0), linetype = "dotted") +
  facet_wrap(~ variable) +
  scale_fill_brewer() +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(breaks = seq(0, 20, 5)) +
  labs(x = "Estimated number of avoided infections", fill = "CrI", title = "c") +
  theme_bw2() +
  theme(axis.title.y = element_blank(), legend.position = "right", 
        axis.text.y = element_blank(), axis.ticks.y = element_blank(),
        plot.title = element_text(hjust = 0),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
  
av_inf_tot_pl

save_plot(av_inf_tot_pl, pdf_file = "../results/redcap-results.pdf", w = 16, h = 3)
```

```{r}
avoided_df_sum_by_d <- avoided_df %>%
  select(dataset, variable, class, draw, value) %>%
  group_by(dataset, variable, draw) %>%
  summarize(value = sum(value)) %>%
  ungroup() %>%
  select(-draw) %>%
  group_by(dataset, variable) %>%
  mean_qi(.width = c(0.5, 0.8, 0.95)) %>%
  ungroup() %>%
  group_by(variable, .width) %>%
  arrange(value) %>%
  mutate(order = 1:n()) %>%
  ungroup()
  

av_inf_tot_by_d_pl <- ggplot(data = avoided_df_sum_by_d, mapping = aes(y = order)) +
  geom_ribbon(mapping = aes(xmin = .lower, xmax = .upper, fill = factor(.width, levels = c(.95, .8, .5)))) +
  geom_point(mapping = aes(x = value), size = 2, fill = "white", shape = 21) +
  geom_vline(mapping = aes(xintercept = 0), linetype = "dotted") + 
  facet_wrap(~ variable) +
  scale_fill_brewer() +
  scale_y_continuous(expand = c(0,0)) +
  labs(x = "Estimated number of avoided infections for each simulated dataset", fill = "CrI", alpha = "CrI") +
  theme_bw2() +
  theme(axis.title.y = element_blank(), plot.title = element_text(hjust = 0), legend.position = "none",
        axis.text.y = element_blank(), axis.ticks.y = element_blank())

av_inf_tot_by_d_pl

save_plot(av_inf_tot_by_d_pl, pdf_file = "../results/redcap-supp-results-by-dataset.pdf", w = 16, h = 18)
```