---
title: "descriptives-redcap.rmd"
author: "NB"
date: "2022-08-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Libraries

```{r}
library(tidyverse)
library(tidybayes)
library(lubridate)
library(reshape2)
library(xtable)

source("../utils/epi.r")
source("../utils/plotting.r")
```


## Data

```{r}
df <- read_csv("../data-clean/redcap-cases.csv") %>%
  filter(!is_teacher) %>% # ignore cases from teachers 
  select(-is_teacher) %>%
  mutate(class = factor(class, levels = c("Study (A)", "Study (B)", "Study", "Control")))

full_df <- readRDS("../data-clean/redcap-full-range.rds")

absences_df <- read_csv("../data-clean/redcap-absences.csv")

sim_df <- data.frame(folders = list.files("../fitted-models/multiverse", full.names = T),
                     dataset = as.numeric(list.files("../fitted-models/multiverse"))) %>%
  arrange(dataset) %>%
  rowwise() %>%
  mutate(sample_file = sapply(folders, list.files, pattern = "sample.rds", full.names = T)) %>%
  mutate(sample = lapply(sample_file, readRDS)) %>%
  unnest() 

sim_modeling_df <- data.frame(folders = list.files("../fitted-models/multiverse", full.names = T),
                     dataset = as.numeric(list.files("../fitted-models/multiverse"))) %>%
  arrange(dataset) %>%
  rowwise() %>%
  mutate(sample_file = sapply(folders, list.files, pattern = "sample-modeling-df.rds", full.names = T)) %>%
  mutate(sample = lapply(sample_file, readRDS)) %>%
  unnest()
```


## Descriptives

### Total cases

```{r}
total_freq_pl <- sim_df  %>%
  left_join(full_df %>% 
              rename(date_start = date) %>%
              select(school, class, date_start, intervention)) %>%
  group_by(dataset, school, class, intervention) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  group_by(school, class, intervention) %>%
  summarise(n = mean(n)) %>%
  ungroup() %>%
  mutate(intervention = factor(intervention, levels = rev(c("None", "Mask mandate", "Air filter")))) %>%
  ggplot(aes(x = class, y = n, fill = intervention)) +
  geom_bar(position = "stack", stat = "identity", width = .5) +
  scale_fill_manual(values = rev(c("black", cbPalette[1:2]))) +
  facet_wrap(~ school, scales = "free_x")  +
  scale_y_continuous(expand = expansion(add = c(0., 0.75))) +
  labs(x = "Class", y = "Expected number of cases", title = "a") +
  theme_bw2() +
  theme(legend.position = "right", plot.title = element_text(hjust = 0),
        legend.title = element_blank(), axis.title.x = element_blank())

total_freq_pl
``` 

### New cases

```{r}
col_order <- c("School 1 Study (A)", "School 1 Study (B)", "School 1 Control", "School 2 Study", "School 2 Control")

cases_time_pl <- sim_modeling_df %>%
  group_by(school_class, school, class, date, intervention, weekend, no_school) %>%
  summarise(new_cases = mean(new_cases)) %>%
  ungroup() %>%
  mutate(intervention = as.character(intervention), 
         intervention = ifelse(weekend == 1, "Weekend", ifelse(no_school, "Vacation", intervention)),
         intervention = ifelse(school == "School 2" & date >= as.Date("2022-03-19"), "", intervention),
         intervention = factor(intervention, levels = c("None", "Mask mandate", "Air filter", "Vacation", "Weekend", "")),
         school_class = factor(school_class, col_order)) %>%
  ggplot(aes(x = date, y = new_cases)) +
  geom_step() +
  geom_tile(aes(y = 0, height = Inf, fill = intervention), alpha = .2) +
  facet_wrap(~ school_class, ncol = 1) +
  scale_fill_manual(values = c("black", cbPalette[1:4], "white")) +
  scale_x_date(expand = c(0,0)) +
  scale_y_continuous(expand = expansion(add = c(0, .1))) +
  labs(y = "Expected number of new cases", title = "b") +
  theme_bw2() +
  theme(legend.title = element_blank(), axis.title.x = element_blank())

cases_time_pl

descriptives_pl <- arrangeGrob(total_freq_pl, cases_time_pl, heights = c(5, 10), ncol = 1)
ggsave(plot = descriptives_pl, filename = "../results/redcap-descriptives.pdf", width = 16 / cm(1), height = 15 / cm(1))
```

### Comparing sim

```{r}
case_lab <- c("Confirmed (positive test result)", "Confirmed (isolation)", "Suspected (known symptoms)", "Suspected (unknown symptoms)")
names(case_lab) <- c("confirmed", "isolated", "symptomatic", "unknown")

new_df <- df %>%
  rename(date = date_start) %>%
  group_by(school_class, date, suspected) %>%
  summarise(new_cases = n()) %>%
  ungroup() %>%
  mutate(suspected = recode(suspected, !!! case_lab),
         suspected = factor(suspected, levels = rev(case_lab)))

comp_sim_pl <- sim_modeling_df %>%
  group_by(school_class, school, class, date) %>%
  summarise(new_cases = mean(new_cases)) %>%
  ungroup() %>%
  mutate(school_class = factor(school_class, col_order)) %>%
  ggplot(aes(x = date, y = new_cases)) +
  geom_bar(data = new_df, mapping = aes(fill = suspected), stat = "identity") +
  geom_step() +
  facet_wrap(~ school_class, ncol = 1) +
  scale_fill_manual(values = (c(RColorBrewer::brewer.pal(9, "Purples")[c(6,4)], RColorBrewer::brewer.pal(9, "Greens")[c(6,4)])),
                    limits = case_lab) +
  scale_x_date(expand = c(0,0)) +
  scale_y_continuous(expand = expansion(add = c(0, .1))) +
  labs(y = "Expected and observed number of new cases") +
  theme_bw2() +
  theme(legend.title = element_blank(), axis.title.x = element_blank(), legend.position = "bottom")

comp_sim_pl

save_plot(comp_sim_pl, pdf_file = "../results/redcap-supp-descriptives.pdf", w = 16, h = 12)
```

### Table Time Series

```{r}
case_lab <- c("Confirmed (positive test result)", "Confirmed (isolation)", "Suspected (known symptoms)", "Suspected (unknown symptoms)")
names(case_lab) <- c("confirmed", "isolated", "symptomatic", "unknown")

tbl <- df %>%
  mutate(school = gsub("School ", "", school),
         across(c(date_start, date_symptoms), function(x) format(x, "%m-%d")),
         across(c(date_start, date_symptoms), function(x) ifelse(is.na(x), "", as.character(x)))) %>%
  select(school, class, date_start, date_symptoms, suspected) %>%
  group_by(school, class) %>%
  arrange(date_start) %>%
  ungroup() %>%
  mutate(suspected = recode(suspected, !!! case_lab))

tbl1 <- tbl %>%
  filter(school == as.character(1)) %>%
  select(-school) %>%
  as.matrix()

tbl2 <- tbl %>%
  filter(school == as.character(2)) %>%
  select(-school) %>%
  as.matrix()

print.xtable(xtable(tbl1),
             file = "../results/cases-time-series-1.tex",
             type = "latex",
             sanitize.text.function = identity,
             include.colnames = F,
             include.rownames = F,
             only.contents = T,
             hline.after = NULL)

print.xtable(xtable(tbl2),
             file = "../results/cases-time-series-2.tex",
             type = "latex",
             sanitize.text.function = identity,
             include.colnames = F,
             include.rownames = F,
             only.contents = T,
             hline.after = NULL)
```


### Summary table

```{r}
df %>%
  group_by(school, class, suspected) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  dcast(school + class ~ suspected) %>%
  mutate(class = factor(class, levels = c("Study (A)", "Study (B)", "Study", "Control")),
         across(c(confirmed, isolated, symptomatic, unknown), ~ ifelse(.x %>% is.na(), 0, .x)),
         total = confirmed + isolated + symptomatic + unknown)  %>%
  select(school, class, total, confirmed, isolated, symptomatic, unknown) %>%
  as.matrix() %>%
  t()
```


### Molecular data

```{r}
cases <- df %>%
  filter(class != "Control") %>%
  mutate(study_week = week(date_start)) %>%
  group_by(school, study_week, suspected) %>%
  summarize(n()) %>%
  ungroup() %>%
  dcast(school + study_week ~ suspected) %>%
  mutate(across(c(confirmed, isolated, symptomatic, unknown), ~ ifelse(.x %>% is.na(), 0, .x)),
         confirmed = confirmed + isolated) %>%
  select(school, study_week, confirmed, symptomatic, unknown) %>%
  rename(Confirmed = confirmed, 
         `Suspected (known symptoms)` = symptomatic,
         `Suspected (unknown symptoms)` = unknown)  %>%
  group_by(school) %>%
  arrange(study_week) %>%
  mutate(study_week = 1:n()) %>%
  ungroup()

cases_tot <- cases %>%
  group_by(school) %>%
  summarise(across(-study_week, sum)) %>%
  ungroup() %>%
  mutate(study_week = 8)

cases <- rbind(cases, cases_tot) %>%
  group_by(school) %>%
  arrange(study_week) %>%
  ungroup()

n_class <- absences_df %>%
  filter(class != "Control") %>%
  group_by(school, class) %>%
  slice(1) %>%
  ungroup() %>%
  group_by(school) %>%
  summarize(n_class = sum(n_class)) %>%
  ungroup()

absences <- absences_df %>%
  filter(class != "Control") %>%
  mutate(week = week(date)) %>%
  filter(week > 3) %>%
  left_join(full_df %>% 
              select(school, week, no_school) %>%
              group_by(school, week) %>%
              slice(1) %>%
              ungroup()) %>%
  filter(!no_school) %>%
  rename(study_week = week) %>%
  group_by(school, study_week) %>%
  summarize(n_tot_absent = sum(n_absent)) %>%
  ungroup() %>%
  group_by(school) %>%
  arrange(study_week) %>%
  mutate(study_week = 1:n()) %>%
  ungroup() %>%
  left_join(n_class) %>%
  mutate(`No. of students` = round((n_class * 5 - n_tot_absent) / 5)) %>%
  select(school, study_week, `No. of students`)

absences_mean <- absences %>%
  group_by(school) %>%
  summarise(across(-study_week, ~ round(mean(.x), 0))) %>%
  ungroup() %>%
  mutate(study_week = 8)

absences <- rbind(absences, absences_mean) %>%
  group_by(school) %>%
  arrange(study_week) %>%
  ungroup()
  

cases_air <- tibble(
  school = c(rep("School 1", 8), rep("School 2", 8)),
  study_week = c(1:8, 1:8),
  `Saliva` = c(1, 2, 0, 2, 6, 1, 0, 12,
               1, 0, 2, 0, 1, 3, 0, 7),
  `Air` = c(0, 0, 0, 2, 0, 0, 2, 4, 
                    1, 3, 0, 0, 1, 0, 0, 5),
  `Air filter 1` = c(rep("", 7), 2, 
                   rep("", 7), 4),
  `Air filter 2` = c(rep("", 7), 0, 
                   rep("", 7), 3)
)

cases_mol <- left_join(left_join(absences, cases), cases_air) 

cases_mol %>%
  filter(school == "School 1") %>%
  select(-school) %>%
  melt("study_week") %>%
  dcast(variable ~ study_week) %>%
  as.matrix() %>%
  xtable() %>%
  print.xtable(
    file = "../results/redcapr-air-cases-1.tex",
    type = "latex",
    sanitize.text.function = identity,
    include.colnames = F,
    include.rownames = F,
    only.contents = T,
    hline.after = c(1,4))

cases_mol %>%
  filter(school == "School 2") %>%
  select(-school) %>%
  melt("study_week") %>%
  dcast(variable ~ study_week) %>%
  as.matrix() %>%
  xtable() %>%
  print.xtable(
    file = "../results/redcapr-air-cases-2.tex",
    type = "latex",
    sanitize.text.function = identity,
    include.colnames = F,
    include.rownames = F,
    only.contents = T,
    hline.after = c(1,4))
```