---
title: "descriptives-redcap.rmd"
author: "NB"
date: "2022-08-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Libraries

```{r}
library(tidyverse)
library(tidybayes)
library(lubridate)
library(reshape2)
library(xtable)

source("../utils/epi.r")
source("../utils/plotting.r")
```


## Data

```{r}
df <- read_csv("../data-clean/redcap.csv") %>%
  filter(!no_school) %>%
  mutate(class = factor(class, levels = c("Study (A)", "Study (B)", "Study", "Control")))
  

max_n <- nrow(df) / length(unique(df$class))
```


## Descriptives

### Cumulaive cases

```{r}
total_freq_pl <- df  %>%
  group_by(school, class) %>%
  summarise(`Confirmed` = max(cum_confirmed),
            `Suspected (known symptoms)` = max(cum_symptomatic),
            `Suspected (unknown symptoms)` = max(cum_unknown)) %>%
  ungroup() %>%
  melt(c("school", "class")) %>%
  mutate(variable = factor(variable, levels = rev(c("Confirmed", "Suspected (known symptoms)", "Suspected (unknown symptoms)")))) %>%
  ggplot(aes(x = class, y = value, fill = variable)) +
  geom_bar(position = "stack", stat = "identity", width = .5, color = "black") +
  scale_fill_brewer() +
  facet_wrap(~ school, scales = "free_x")  +
  scale_y_continuous(expand = expansion(add = c(0., 0.75))) +
  labs(x = "Class", y = "Number of cases", title = "a") +
  theme_bw2() +
  theme(legend.position = "right", plot.title = element_text(hjust = 0),
        legend.title = element_blank(), axis.title.x = element_blank())

total_freq_pl
``` 

### New confirmed cases

```{r}
df_new <- df %>%
  group_by(school, class) %>%
  arrange(date) %>%
  mutate(day = 1:n()) %>%
  ungroup() %>%
  mutate(new_suspected = new_symptomatic + new_unknown) %>%
  select(school, class, week, day, intervention, new_confirmed, new_suspected) %>%
  melt(c("school", "class", "week", "day", "intervention")) %>%
  mutate(variable = ifelse(variable == "new_confirmed", "Confirmed", "Suspected"),
         variable = factor(variable, levels = rev(c("Confirmed", "Suspected")))) %>%
  mutate(value = ifelse(value == 0, NA, value),
         class = factor(class, levels = rev(c("Study (A)", "Study (B)", "Study", "Control"))))

maskmandate_dates <- df %>%
  group_by(school, date, intervention) %>%
  slice(1) %>%
  ungroup() %>%
  group_by(school) %>%
  arrange(date) %>%
  mutate(day = 1:n()) %>%
  filter(intervention == "None") %>%
  slice(1) %>%
  ungroup() %>%
  select(school, date, day) %>%
  mutate(day = day -1,
         intervention = "Mask mandate",
         start_day = -Inf) %>%
  rename(end_day = day)

airfilter_dates <- df %>%
  group_by(school, date, intervention) %>%
  slice(1) %>%
  ungroup() %>%
  group_by(school) %>%
  arrange(date) %>%
  mutate(day = 1:n()) %>%
  filter(intervention == "Air filter") %>%
  slice(1) %>%
  ungroup() %>%
  select(school, date, day) %>%
  mutate(intervention = "Air filter",
         end_day = Inf) %>%
  rename(start_day = day)

intervention_dates <- rbind(maskmandate_dates, airfilter_dates) %>%
  mutate(intervention = factor(intervention, levels = c("Mask mandate", "Air filter")),
         ymin = ifelse(intervention == "Mask mandate", -Inf, 1.5),
         ymax = Inf)

cases_time_pl <- ggplot() +
  geom_rect(data = intervention_dates, 
            mapping = aes(xmin = start_day, xmax = end_day, fill = intervention, ymin = ymin, ymax = ymax), alpha = .15) +
  geom_point(data = df_new, mapping = aes(x = day, y = class, size = value, color = variable), shape = 21) +
  annotate(geom = "text", x = 5, y = .6, label = "Mask mandate", size = 6 / cm(1), color = cbPalette[1]) +
  annotate(geom = "text", x = 45, y = 1.7, label = "Air filter", size = 6 / cm(1), color = cbPalette[2]) +
  facet_wrap(~ school, scales = "free_y", ncol = 1) +
  scale_fill_manual(values = cbPalette) +
  scale_size(range = c(4,8), breaks = seq(0, 3, 1)) +
  scale_x_continuous(breaks = seq(1, 70, 5)) +
  scale_y_discrete() +
  scale_color_manual(values = RColorBrewer::brewer.pal(9, "Blues")[c(4,8)]) +
  labs(x = "Day of study period", y = "Class", title = "b",
       size = "Number of new cases", alpha = "Number of new cases", fill = "Intervention",
       color = "Cases") +
  theme_bw2() +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0), axis.title = element_blank()) +
  guides(color = guide_legend(title.position = "top"),
         size = guide_legend(title.position = "top"),
         fill = guide_legend(title.position = "top"))

cases_time_pl
```


### Summary

```{r}
comb_pl <- arrangeGrob(total_freq_pl, cases_time_pl, heights = c(4, 8), ncol = 1)

ggsave(plot = comb_pl, filename = "../results/redcap-descriptives.pdf", width = 16 / cm(1), height = 12 / cm(1))
```


### Table Time Series

```{r}
tbl <- df %>%
  mutate(weekday = weekdays(date, abbreviate = T),
         school = gsub("School ", "", school),
         date = format(date, "%m-%d")) %>%
  group_by(school, class) %>%
  arrange(date) %>%
  mutate(day = 1:n()) %>%
  ungroup() %>%
  select(school, class, date, week, weekday, day, intervention, new_confirmed, new_symptomatic, new_unknown) 

tbl1 <- tbl %>%
  filter(school == as.character(1)) %>%
  select(-school) %>%
  as.matrix()

tbl2 <- tbl %>%
  filter(school == as.character(2)) %>%
  select(-school) %>%
  as.matrix()

print.xtable(xtable(tbl1),
             file = "../results/cases-time-series-1.tex",
             type = "latex",
             sanitize.text.function = identity,
             include.colnames = F,
             include.rownames = F,
             only.contents = T,
             hline.after = NULL)

print.xtable(xtable(tbl2),
             file = "../results/cases-time-series-2.tex",
             type = "latex",
             sanitize.text.function = identity,
             include.colnames = F,
             include.rownames = F,
             only.contents = T,
             hline.after = NULL)
```


### Summary table

```{r}
df %>%
  mutate(cum_total = cum_confirmed + cum_symptomatic + cum_unknown) %>%
  group_by(school, class) %>%
  summarize(across(c(cum_total, cum_confirmed, cum_symptomatic, cum_unknown), max)) %>%
  ungroup() %>%
  mutate(class = factor(class, levels = c("Study (A)", "Study (B)", "Study", "Control")))  %>%
  arrange(school, desc(class)) %>%
  as.matrix() %>%
  t()
```


### Molecular data

```{r}
cases <- df %>%
  filter(class != "Control") %>%
  group_by(school, week) %>%
  summarize(confirmed = sum(new_confirmed),
            suspected_known = sum(new_symptomatic),
            suspected_unknown = sum(new_unknown)) %>%
  ungroup() %>%
  group_by(school) %>%
  arrange(week) %>%
  mutate(study_week = 1:n() - 1,
         study_week = ifelse(study_week == 0, 1, study_week)) %>%
  ungroup() %>%
  group_by(school, study_week) %>%
  summarize(Confirmed = sum(confirmed),
            `Suspected (known symptoms)` = sum(suspected_known),
            `Suspected (unknown symptoms)` = sum(suspected_unknown)) %>%
  ungroup() 

absences <- df %>%
  filter(class != "Control") %>%
  filter(!(weekday %in% c("Saturday", "Sunday"))) %>%
  group_by(school, week) %>%
  summarize(n_class = sum(n_class),
            n_tot_absent = sum(n_tot_absent)) %>%
  ungroup() %>%
  group_by(school) %>%
  arrange(week) %>%
  mutate(study_week = 1:n() - 1) %>%
  ungroup() %>%
  filter(study_week > 0) %>% # ignore the Friday in the first week where there were just 1 absence)
  mutate(`No. of students` = round((n_class - n_tot_absent) / 5)) %>%
  select(school, study_week, `No. of students`)
  

cases_air <- data.frame(
  school = c(rep("School 1", 7), rep("School 2", 7)),
  study_week = c(1:7, 1:7),
  Air = c(0, 0, 0, 2, 0, 0, 2, 
          1, 3, 0, 0, 1, 0, 0)
)

cases_mol <- left_join(left_join(absences, cases), cases_air) 

cases_mol %>%
  filter(school == "School 1") %>%
  select(-school) %>%
  melt("study_week") %>%
  dcast(variable ~ study_week) %>%
  as.matrix() %>%
  xtable() %>%
  print.xtable(
    file = "../results/redcapr-air-cases-1.tex",
    type = "latex",
    sanitize.text.function = identity,
    include.colnames = F,
    include.rownames = F,
    only.contents = T,
    hline.after = c(1,4))

cases_mol %>%
  filter(school == "School 2") %>%
  select(-school) %>%
  melt("study_week") %>%
  dcast(variable ~ study_week) %>%
  as.matrix() %>%
  xtable() %>%
  print.xtable(
    file = "../results/redcapr-air-cases-2.tex",
    type = "latex",
    sanitize.text.function = identity,
    include.colnames = F,
    include.rownames = F,
    only.contents = T,
    hline.after = c(1,4))
```