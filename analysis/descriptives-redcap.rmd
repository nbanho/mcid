---
title: "descriptives-redcap.rmd"
author: "NB"
date: "2022-08-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Libraries

```{r}
library(tidyverse)
library(tidybayes)
library(lubridate)
library(reshape2)

source("../utils/epi.r")
source("../utils/plotting.r")
```


## Data

```{r}
df <- read_csv("../data-clean/redcap.csv") %>%
  filter(!no_school)

max_n <- df %>% filter(class == "Study (B3d)") %>% nrow
```


## Descriptives

### Cumulaive cases

```{r}
total_freq_pl <- df  %>%
  group_by(school, class) %>%
  summarise(Confirmed = max(cum_confirmed),
            Symptomatic = max(cum_symptomatic),
            Isolated = max(cum_isolated)) %>%
  ungroup() %>%
  melt(c("school", "class")) %>%
  mutate(variable = factor(variable, levels = rev(c("Confirmed", "Isolated", "Symptomatic")))) %>%
  ggplot(aes(x = class, y = value, fill = variable)) +
  geom_bar(position = "stack", stat = "identity", width = .5, color = "black") +
  scale_fill_brewer() +
  facet_wrap(~ school, scales = "free_x")  +
  scale_y_continuous(expand = expansion(add = c(0., 0.75))) +
  labs(x = "Class", y = "Total number of cases", fill = "Type of case", title = "a") +
  theme_bw2() +
  theme(legend.position = "left") +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0))

total_freq_pl

save_plot(total_freq_pl, "../results/total-frequency-of-cases.pdf", w = 14, h = 6)
``` 

### New confirmed cases

```{r}
df_new <- df %>%
  group_by(school, class) %>%
  arrange(date) %>%
  mutate(day = 1:n()) %>%
  ungroup() %>%
  mutate(`New cases` = new_confirmed_by_onset + new_symptomatic + new_isolated) 

maskmandate_dates <- df_new %>%
  group_by(school) %>%
  arrange(date) %>%
  filter(intervention == "None") %>%
  slice(1) %>%
  ungroup() %>%
  select(school, date, day) %>%
  mutate(day = day -1,
         intervention = "Mask mandate",
         start_day = -Inf) %>%
  rename(end_day = day)

airfilter_dates <- df_new %>%
  group_by(school) %>%
  arrange(date) %>%
  filter(intervention == "Air filter") %>%
  slice(1) %>%
  ungroup() %>%
  select(school, date, day) %>%
  mutate(intervention = "Air filter",
         end_day = Inf) %>%
  rename(start_day = day)

intervention_dates <- rbind(maskmandate_dates, airfilter_dates) %>%
  mutate(intervention = factor(intervention, levels = c("Mask mandate", "Air filter")))

cases_time_pl <- ggplot() +
  geom_rect(data = intervention_dates, mapping = aes(xmin = start_day, xmax = end_day, fill = intervention, ymin = -Inf, ymax = Inf), alpha = .25) +
  geom_point(data = df_new, mapping = aes(x = day, y = class, size = `New cases`, alpha = `New cases`)) +
  annotate(geom = "text", x = 5, y = .6, label = "Mask mandate", size = 6 / cm(1)) +
  annotate(geom = "text", x = 45, y = .6, label = "Air filter", size = 6 / cm(1), color = cbPalette[2]) +
  facet_wrap(~ school, scales = "free_y", ncol = 1) +
  scale_color_brewer() +
  scale_fill_manual(values = cbPalette) +
  scale_size(breaks = seq(0, 3, 1)) +
  scale_x_continuous(breaks = seq(1, 70, 5)) +
  labs(x = "Day of study period", y = "Class", title = "b",
       size = "Number of new cases", alpha = "Number of new cases", fill = "") +
  theme_bw2() +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0))

cases_time_pl

save_plot(cases_time_pl, "../results/cases-over-time.pdf", w = 14, h = 10)
```


### Summary

```{r}
comb_pl <- arrangeGrob(total_freq_pl, cases_time_pl, heights = c(6, 10), ncol = 1)

ggsave(plot = comb_pl, filename = "../results/redcap-descriptives.pdf", width = 14 / cm(1), height = 16 / cm(1))
```