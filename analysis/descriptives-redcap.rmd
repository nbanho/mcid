---
title: "descriptives-redcap.rmd"
author: "NB"
date: "2022-08-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Libraries

```{r}
library(tidyverse)
library(tidybayes)
library(lubridate)
library(reshape2)
library(xtable)

source("../utils/epi.r")
source("../utils/plotting.r")
```


## Data

```{r}
df <- read_csv("../data-clean/redcap-cases.csv") %>%
  filter(!is_teacher) %>% # ignore cases from teachers 
  select(-is_teacher) %>%
  mutate(class = factor(class, levels = c("Study (A)", "Study (B)", "Study", "Control")))

full_df <- readRDS("../data-clean/redcap-full-range.rds")
```


## Descriptives

### Cumulaive cases

```{r}
total_freq_pl <- df  %>%
  group_by(school, class) %>%
  summarise(`Confirmed` = sum(suspected %in% c("confirmed", "isolated")),
            `Suspected (known symptoms)` = sum(suspected == "symptomatic"),
            `Suspected (unknown symptoms)` = sum(suspected == "unknown")) %>%
  ungroup() %>%
  melt(c("school", "class")) %>%
  mutate(variable = factor(variable, levels = rev(c("Confirmed", "Suspected (known symptoms)", "Suspected (unknown symptoms)")))) %>%
  ggplot(aes(x = class, y = value, fill = variable)) +
  geom_bar(position = "stack", stat = "identity", width = .5, color = "black") +
  scale_fill_brewer() +
  facet_wrap(~ school, scales = "free_x")  +
  scale_y_continuous(expand = expansion(add = c(0., 0.75))) +
  labs(x = "Class", y = "Number of cases", title = "a") +
  theme_bw2() +
  theme(legend.position = "right", plot.title = element_text(hjust = 0),
        legend.title = element_blank(), axis.title.x = element_blank())

total_freq_pl
``` 

### New cases

#### by absence

```{r}
# cases
df_new <- df %>%
  group_by(school, class, date_start) %>%
  summarize(Confirmed = sum(suspected %in% c("confirmed", "isolated")),
            Suspected = sum(suspected %in% c("symptomatic", "unknown"))) %>%
  ungroup() %>%
  rename(date = date_start) %>%
  left_join(full_df %>%
              filter(!no_school) %>%
              group_by(school, class) %>%
              arrange(date) %>%
              mutate(day = 1:n()) %>%
              ungroup()) %>%
  select(school, class, day, Confirmed, Suspected) %>%
  melt(c("school", "class", "day")) %>%
  filter(value > 0) %>%
  mutate(variable = factor(variable, levels = c("Suspected", "Confirmed")))

# intervention periods
full_df_relab <- full_df %>%
  filter(!no_school) %>%
  group_by(school, date, intervention) %>%
  slice(1) %>%
  ungroup() %>%
  group_by(school) %>%
  arrange(date) %>%
  mutate(day = 1:n())

maskmandate_dates <- full_df_relab %>%
  filter(intervention == "None") %>%
  slice(1) %>%
  ungroup() %>%
  select(school, date, day) %>%
  mutate(day = day -1,
         intervention = "Mask mandate",
         start_day = -Inf) %>%
  rename(end_day = day)

airfilter_dates <- full_df_relab %>%
  filter(intervention == "Air filter") %>%
  slice(1) %>%
  ungroup() %>%
  select(school, date, day) %>%
  mutate(intervention = "Air filter",
         end_day = Inf) %>%
  rename(start_day = day)

intervention_dates <- rbind(maskmandate_dates, airfilter_dates) %>%
  mutate(intervention = factor(intervention, levels = c("Mask mandate", "Air filter")),
         ymin = ifelse(intervention == "Mask mandate", -Inf, 1.5),
         ymax = Inf)

# plot
cases_time_pl <- ggplot() +
  geom_rect(data = intervention_dates, 
            mapping = aes(xmin = start_day, xmax = end_day, fill = intervention, ymin = ymin, ymax = ymax), alpha = .15) +
  geom_point(data = df_new, mapping = aes(x = day, y = class, size = value, color = variable), shape = 21) +
  annotate(geom = "text", x = 5, y = .6, label = "Mask mandate", size = 6 / cm(1), color = cbPalette[1]) +
  annotate(geom = "text", x = 45, y = 1.7, label = "Air filter", size = 6 / cm(1), color = cbPalette[2]) +
  facet_wrap(~ school, scales = "free_y", ncol = 1) +
  scale_fill_manual(values = cbPalette) +
  scale_size(range = c(4,8), breaks = seq(0, 4, 1)) +
  scale_x_continuous(breaks = seq(1, 70, 5)) +
  scale_y_discrete() +
  scale_color_manual(values = RColorBrewer::brewer.pal(9, "Blues")[c(4,8)]) +
  labs(x = "Day of study period (excluding vacation)", y = "Class", title = "b",
       size = "Number of new cases", alpha = "Number of new cases", fill = "Intervention",
       color = "Cases by date of absence") +
  theme_bw2() +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0), axis.title.y = element_blank()) +
  guides(color = guide_legend(title.position = "top"),
         size = guide_legend(title.position = "top"),
         fill = guide_legend(title.position = "top"))

cases_time_pl
```

#### by symptom onset

```{r}
sim_df <- data.frame(folders = list.files("../fitted-models/multiverse", full.names = T),
                     dataset = as.numeric(list.files("../fitted-models/multiverse"))) %>%
  arrange(dataset) %>%
  rowwise() %>%
  mutate(sample_file = sapply(folders, list.files, pattern = "sample.rds", full.names = T)) %>%
  mutate(sample = lapply(sample_file, readRDS)) %>%
  unnest() 

sim_df_new <- full_df %>% 
  left_join(sim_df %>%
              group_by(school, class, date_symptoms) %>%
              summarize(Confirmed = sum(suspected %in% c("confirmed", "isolated") / max(sim_df$dataset)),
                        Suspected = sum(suspected %in% c("symptomatic", "unknown") / max(sim_df$dataset))) %>%
              ungroup() %>%
              rename(date = date_symptoms)) 

sim_df_new_phases <- sim_df_new %>%
  group_by(school, date) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(intervention = as.character(intervention), 
         intervention = ifelse(weekend == 1, "Weekend", ifelse(no_school, "Vacation", intervention)),
         y = ifelse(intervention == "Air filter", ifelse(school == "School 1", 2.5, 2), ifelse(school == "School 1", 2, 1.5)),
         height = ifelse(intervention == "Air filter", ifelse(school == "School 1", 2, 1), ifelse(school == "School 1", 3, 2)),
         intervention = ifelse(school == "School 2" & date >= as.Date("2022-03-21"), "Study ended", intervention),
         intervention = factor(intervention, levels = c("Mask mandate", "Air filter", "None", "Vacation", "Weekend", "Study ended")))
  
sim_df_new <- sim_df_new %>%
  select(school, class, date, Confirmed, Suspected) %>%
  melt(c("school", "class", "date")) %>%
  mutate(variable = factor(variable, levels = c("Suspected", "Confirmed")),
         value = ifelse(value == 0, NA, value))

# plot
cases_time_so_pl <-  ggplot() +
  geom_point(data = sim_df_new, mapping = aes(x = date, y = class, size = value, color = variable), shape = 21) +
  geom_tile(data = sim_df_new_phases, mapping = aes(x = date,  fill = intervention, y = y, height = height), alpha = .15) +
  #annotate(geom = "text", x = 5, y = .6, label = "Mask mandate", size = 6 / cm(1), color = cbPalette[1]) +
  #annotate(geom = "text", x = 45, y = 1.7, label = "Air filter", size = 6 / cm(1), color = cbPalette[2]) +
  facet_wrap(~ school, scales = "free_y", ncol = 1) +
  scale_fill_manual(values = c(cbPalette[1:2], "white", cbPalette[3:4], "grey1")) +
  scale_x_date(expand = c(0,0)) +
  scale_y_discrete(expand = c(0,0)) +
  scale_size(range = c(4,8) * (max(sim_df_new$value, na.rm = T) / max(df_new$value)), breaks = seq(.7, 3, .7)) +
  scale_color_manual(values = RColorBrewer::brewer.pal(9, "Blues")[c(4,8)]) +
  labs(x = "Date", y = "Class",
       size = "Mean number of new cases\nacross simulations", alpha = "Mean number of new cases\nacross simulations", fill = "Phase of the study period",
       color = "Cases by date of\nsymptom onset") +
  theme_bw2() +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0), axis.title.y = element_blank()) +
  guides(color = guide_legend(title.position = "top", nrow = 2),
         size = guide_legend(title.position = "top", nrow = 2),
         fill = guide_legend(title.position = "top"))

cases_time_so_pl

save_plot(cases_time_so_pl, pdf_file = "../results/redcap-supp-descriptives.pdf", w = 16, h = 8)
```


### Summary

```{r}
comb_pl <- arrangeGrob(total_freq_pl, cases_time_pl, heights = c(4, 9), ncol = 1)

ggsave(plot = comb_pl, filename = "../results/redcap-descriptives.pdf", width = 16 / cm(1), height = 13 / cm(1))
```


### Table Time Series

```{r}
tbl <- df %>%
  mutate(weekday = weekdays(date, abbreviate = T),
         school = gsub("School ", "", school),
         date = format(date, "%m-%d")) %>%
  group_by(school, class) %>%
  arrange(date) %>%
  mutate(day = 1:n()) %>%
  ungroup() %>%
  select(school, class, date, week, weekday, day, intervention, new_confirmed, new_symptomatic, new_unknown) 

tbl1 <- tbl %>%
  filter(school == as.character(1)) %>%
  select(-school) %>%
  as.matrix()

tbl2 <- tbl %>%
  filter(school == as.character(2)) %>%
  select(-school) %>%
  as.matrix()

print.xtable(xtable(tbl1),
             file = "../results/cases-time-series-1.tex",
             type = "latex",
             sanitize.text.function = identity,
             include.colnames = F,
             include.rownames = F,
             only.contents = T,
             hline.after = NULL)

print.xtable(xtable(tbl2),
             file = "../results/cases-time-series-2.tex",
             type = "latex",
             sanitize.text.function = identity,
             include.colnames = F,
             include.rownames = F,
             only.contents = T,
             hline.after = NULL)
```


### Summary table

```{r}
df %>%
  mutate(cum_total = cum_confirmed + cum_symptomatic + cum_unknown) %>%
  group_by(school, class) %>%
  summarize(across(c(cum_total, cum_confirmed, cum_symptomatic, cum_unknown), max)) %>%
  ungroup() %>%
  mutate(class = factor(class, levels = c("Study (A)", "Study (B)", "Study", "Control")))  %>%
  arrange(school, desc(class)) %>%
  as.matrix() %>%
  t()
```


### Molecular data

```{r}
cases <- df %>%
  filter(class != "Control") %>%
  group_by(school, week) %>%
  summarize(confirmed = sum(new_confirmed),
            suspected_known = sum(new_symptomatic),
            suspected_unknown = sum(new_unknown)) %>%
  ungroup() %>%
  group_by(school) %>%
  arrange(week) %>%
  mutate(study_week = 1:n() - 1,
         study_week = ifelse(study_week == 0, 1, study_week)) %>%
  ungroup() %>%
  group_by(school, study_week) %>%
  summarize(Confirmed = sum(confirmed),
            `Suspected (known symptoms)` = sum(suspected_known),
            `Suspected (unknown symptoms)` = sum(suspected_unknown)) %>%
  ungroup() 

cases_tot <- cases %>%
  group_by(school) %>%
  summarise(across(-study_week, sum)) %>%
  ungroup() %>%
  mutate(study_week = 8)

cases <- rbind(cases, cases_tot) %>%
  group_by(school) %>%
  arrange(study_week) %>%
  ungroup()

absences <- df %>%
  filter(class != "Control") %>%
  filter(!(weekday %in% c("Saturday", "Sunday"))) %>%
  group_by(school, week) %>%
  summarize(n_class = sum(n_class),
            n_tot_absent = sum(n_tot_absent)) %>%
  ungroup() %>%
  group_by(school) %>%
  arrange(week) %>%
  mutate(study_week = 1:n() - 1) %>%
  ungroup() %>%
  filter(study_week > 0) %>% # ignore the Friday in the first week where there were just 1 absence)
  mutate(`No. of students` = round((n_class - n_tot_absent) / 5)) %>%
  select(school, study_week, `No. of students`)

absences_mean <- absences %>%
  group_by(school) %>%
  summarise(across(-study_week, ~ round(mean(.x), 0))) %>%
  ungroup() %>%
  mutate(study_week = 8)

absences <- rbind(absences, absences_mean) %>%
  group_by(school) %>%
  arrange(study_week) %>%
  ungroup()
  

cases_air <- tibble(
  school = c(rep("School 1", 8), rep("School 2", 8)),
  study_week = c(1:8, 1:8),
  `Saliva` = c(1, 2, 0, 2, 6, 1, 0, 12,
               1, 0, 2, 0, 1, 3, 0, 7),
  `Air` = c(0, 0, 0, 2, 0, 0, 2, 4, 
                    1, 3, 0, 0, 1, 0, 0, 5),
  `Air filter 1` = c(rep("", 7), 2, 
                   rep("", 7), 4),
  `Air filter 2` = c(rep("", 7), 0, 
                   rep("", 7), 3)
)

cases_mol <- left_join(left_join(absences, cases), cases_air) 

cases_mol %>%
  filter(school == "School 1") %>%
  select(-school) %>%
  melt("study_week") %>%
  dcast(variable ~ study_week) %>%
  as.matrix() %>%
  xtable() %>%
  print.xtable(
    file = "../results/redcapr-air-cases-1.tex",
    type = "latex",
    sanitize.text.function = identity,
    include.colnames = F,
    include.rownames = F,
    only.contents = T,
    hline.after = c(1,4))

cases_mol %>%
  filter(school == "School 2") %>%
  select(-school) %>%
  melt("study_week") %>%
  dcast(variable ~ study_week) %>%
  as.matrix() %>%
  xtable() %>%
  print.xtable(
    file = "../results/redcapr-air-cases-2.tex",
    type = "latex",
    sanitize.text.function = identity,
    include.colnames = F,
    include.rownames = F,
    only.contents = T,
    hline.after = c(1,4))
```